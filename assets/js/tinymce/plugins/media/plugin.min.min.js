!function(){var a3=tinymce.util.Tools.resolve("tinymce.PluginManager"),aT=tinymce.util.Tools.resolve("tinymce.Env"),aM=tinymce.util.Tools.resolve("tinymce.util.Tools"),aL=function(a){return a.getParam("media_scripts")},a6=function(a){return a.getParam("audio_template_callback")},aI=function(a){return a.getParam("video_template_callback")},aU=function(a){return a.getParam("media_live_embeds",!0)},aO=function(a){return a.getParam("media_filter_html",!0)},aP=function(a){return a.getParam("media_url_resolver")},aV=function(a){return a.getParam("media_alt_source",!0)},a4=function(a){return a.getParam("media_poster",!0)},a0=function(a){return a.getParam("media_dimensions",!0)},aS=tinymce.util.Tools.resolve("tinymce.html.SaxParser"),aQ=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),aK=function(c,a){if(c){for(var b=0;b<c.length;b++){if(-1!==a.indexOf(c[b].filter)){return c[b]}}}},aZ=function(a){return function(b){return b?b.style[a].replace(/px$/,""):""}},a8=function(a){return function(d,b){var c;d&&(d.style[a]=/^[0-9.]+$/.test(c=b)?c+"px":c)}},a2={getMaxWidth:aZ("maxWidth"),getMaxHeight:aZ("maxHeight"),setMaxWidth:a8("maxWidth"),setMaxHeight:a8("maxHeight")},aN=aQ.DOM,aW=function(a){return aN.getAttrib(a,"data-ephox-embed-iri")},aY=function(h,l){return j=l,m=aN.createFragment(j),""!==aW(m.firstChild)?(d=l,f=aN.createFragment(d).firstChild,{type:"ephox-embed-iri",source1:aW(f),source2:"",poster:"",width:a2.getMaxWidth(f),height:a2.getMaxHeight(f)}):(g=h,b=l,aS({validate:(k={},!1),allow_conditional_comments:!0,special:"script,noscript",start:function(i,a){if(k.source1||"param"!==i||(k.source1=a.map.movie),"iframe"!==i&&"object"!==i&&"embed"!==i&&"video"!==i&&"audio"!==i||(k.type||(k.type=i),k=aM.extend(a.map,k)),"script"===i){var c=aK(g,a.map.src);if(!c){return}k={type:"script",source1:a.map.src,width:c.width,height:c.height}}"source"===i&&(k.source1?k.source2||(k.source2=a.map.src):k.source1=a.map.src),"img"!==i||k.poster||(k.poster=a.map.src)}}).parse(b),k.source1=k.source1||k.src||k.data,k.source2=k.source2||"",k.poster=k.poster||"",k);var g,b,k,d,f,j,m},a1=tinymce.util.Tools.resolve("tinymce.util.Promise"),ap=function(b){var a={mp3:"audio/mpeg",wav:"audio/wav",mp4:"video/mp4",webm:"video/webm",ogg:"video/ogg",swf:"application/x-shockwave-flash"}[b.toLowerCase().split(".").pop()];return a||""},a9=tinymce.util.Tools.resolve("tinymce.html.Writer"),aB=tinymce.util.Tools.resolve("tinymce.html.Schema"),aj=aQ.DOM,ax=function(g,d){var f,c,b,h;for(f in d){if(b=""+d[f],g.map[f]){for(c=g.length;c--;){(h=g[c]).name===f&&(b?(g.map[f]=b,h.value=b):(delete g.map[f],g.splice(c,1)))}}else{b&&(g.push({name:f,value:b}),g.map[f]=b)}}},aX=function(g,d){var f,c,b=aj.createFragment(g).firstChild;return a2.setMaxWidth(b,d.width),a2.setMaxHeight(b,d.height),f=b.outerHTML,c=a9(),aS(c).parse(f),c.getContent()},aD=function(j,q,b){return p=j,g=aj.createFragment(p),""!==aj.getAttrib(g.firstChild,"data-ephox-embed-iri")?aX(j,q):(h=j,m=q,d=b,k=a9(),aS({validate:!1,allow_conditional_comments:!(v=0),special:"script,noscript",comment:function(a){k.comment(a)},cdata:function(a){k.cdata(a)},text:function(c,a){k.text(c,a)},start:function(i,a,c){switch(i){case"video":case"object":case"embed":case"img":case"iframe":m.height!==undefined&&m.width!==undefined&&ax(a,{width:m.width,height:m.height})}if(d){switch(i){case"video":ax(a,{poster:m.poster,src:""}),m.source2&&ax(a,{src:""});break;case"iframe":ax(a,{src:m.source1});break;case"source":if(++v<=2&&(ax(a,{src:m["source"+v],type:m["source"+v+"mime"]}),!m["source"+v])){return}break;case"img":if(!m.poster){return}f=!0}}k.start(i,a,c)},end:function(n){if("video"===n&&d){for(var c=1;c<=2;c++){if(m["source"+c]){var l=[];l.map={},v<c&&(ax(l,{src:m["source"+c],type:m["source"+c+"mime"]}),k.start("source",l,!0))}}}if(m.poster&&"object"===n&&d&&!f){var a=[];a.map={},ax(a,{src:m.poster,width:m.width,height:m.height}),k.start("img",a,!0)}k.end(n)}},aB({})).parse(h),k.getContent());var h,m,d,f,k,v,p,g},ao=[{regex:/youtu\.be\/([\w\-_\?&=.]+)/i,type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/youtube\.com(.+)v=([^&]+)(&([a-z0-9&=\-_]+))?/i,type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$2?$4",allowFullscreen:!0},{regex:/youtube.com\/embed\/([a-z0-9\?&=\-_]+)/i,type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc",allowFullscreen:!0},{regex:/vimeo\.com\/(.*)\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$2?title=0&amp;byline=0",allowFullscreen:!0},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'//maps.google.com/maps/ms?msid=$2&output=embed"',allowFullscreen:!1},{regex:/dailymotion\.com\/video\/([^_]+)/,type:"iframe",w:480,h:270,url:"//www.dailymotion.com/embed/video/$1",allowFullscreen:!0},{regex:/dai\.ly\/([^_]+)/,type:"iframe",w:480,h:270,url:"//www.dailymotion.com/embed/video/$1",allowFullscreen:!0}],a5=function(b,B){var x=aM.extend({},B);if(!x.source1&&(aM.extend(x,aY(aL(b),x.embed)),!x.source1)){return""}x.source2||(x.source2=""),x.poster||(x.poster=""),x.source1=b.convertURL(x.source1,"source"),x.source2=b.convertURL(x.source2,"source"),x.source1mime=ap(x.source1),x.source2mime=ap(x.source2),x.poster=b.convertURL(x.poster,"poster");var G,E,k=(G=x.source1,0<(E=ao.filter(function(a){return a.regex.test(G)})).length?aM.extend({},E[0],{url:function(h,f){for(var g=h.regex.exec(f),d=h.url,c=function(a){d=d.replace("$"+a,function(){return g[a]?g[a]:""})},l=0;l<g.length;l++){c(l)}return d.replace(/\?$/,"")}(E[0],G)}):null);if(k&&(x.source1=k.url,x.type=k.type,x.allowFullscreen=k.allowFullscreen,x.width=x.width||k.w,x.height=x.height||k.h),x.embed){return aD(x.embed,x,!0)}var q=aK(aL(b),x.source1);q&&(x.type="script",x.width=q.width,x.height=q.height);var D,H,F,w,v,C,y,j,A=a6(b),z=aI(b);return x.width=x.width||300,x.height=x.height||150,aM.each(x,function(c,a){x[a]=b.dom.encode(c)}),"iframe"===x.type?(j=(y=x).allowFullscreen?' allowFullscreen="1"':"",'<iframe src="'+y.source1+'" width="'+y.width+'" height="'+y.height+'"'+j+"></iframe>"):"application/x-shockwave-flash"===x.source1mime?(C='<object data="'+(v=x).source1+'" width="'+v.width+'" height="'+v.height+'" type="application/x-shockwave-flash">',v.poster&&(C+='<img src="'+v.poster+'" width="'+v.width+'" height="'+v.height+'" />'),C+="</object>"):-1!==x.source1mime.indexOf("audio")?(F=x,(w=A)?w(F):'<audio controls="controls" src="'+F.source1+'">'+(F.source2?'\n<source src="'+F.source2+'"'+(F.source2mime?' type="'+F.source2mime+'"':"")+" />\n":"")+"</audio>"):"script"===x.type?'<script src="'+x.source1+'"><\/script>':(D=x,(H=z)?H(D):'<video width="'+D.width+'" height="'+D.height+'"'+(D.poster?' poster="'+D.poster+'"':"")+' controls="controls">\n<source src="'+D.source1+'"'+(D.source1mime?' type="'+D.source1mime+'"':"")+" />\n"+(D.source2?'<source src="'+D.source2+'"'+(D.source2mime?' type="'+D.source2mime+'"':"")+" />\n":"")+"</video>")},an={},am=function(a){return function(b){return a5(a,b)}},ai=function(h,f){var g,d,b,j,l,k=aP(h);return k?(b=f,j=am(h),l=k,new a1(function(a,i){var c=function(m){return m.html&&(an[b.source1]=m),a({url:b.source1,html:m.html?m.html:j(b)})};an[b.source1]?c(an[b.source1]):l({url:b.source1},c,i)})):(g=f,d=am(h),new a1(function(a){a({html:d(g),url:g.source1})}))},aE=function(a){return an.hasOwnProperty(a)},aH=function(b,a){b.state.set("oldVal",b.value()),a.state.set("oldVal",a.value())},aq=function(g,d){var f=g.find("#width")[0],c=g.find("#height")[0],b=g.find("#constrain")[0];f&&c&&b&&d(f,c,b.checked())},av=function(g,d,f){var c=g.state.get("oldVal"),b=d.state.get("oldVal"),h=g.value(),j=d.value();f&&c&&b&&h&&j&&(h!==c?(j=Math.round(h/c*j),isNaN(j)||d.value(j)):(h=Math.round(j/b*h),isNaN(h)||g.value(h))),aH(g,d)},af=function(a){aq(a,av)},at=function(b){var a=function(){b(function(c){af(c)})};return{type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:5,onchange:a,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:5,onchange:a,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}},ak=function(a){aq(a,aH)},aA=af,ay=aT.ie&&aT.ie<=8?"onChange":"onInput",au=function(a){return function(c){var b=c&&c.msg?"Media embed handler error: "+c.msg:"Media embed handler threw unknown error.";a.notificationManager.open({type:"error",text:b})}},ah=function(b,c){return function(g){var d=g.html,f=b.find("#embed")[0],a=aM.extend(aY(aL(c),d),{source1:g.url});b.fromJSON(a),f&&(f.value(d),aA(b))}},ag=function(c,a){var b=c.dom.select("img[data-mce-object]");c.insertContent(a),function(j,g){var h,f,d=j.dom.select("img[data-mce-object]");for(h=0;h<g.length;h++){for(f=d.length-1;0<=f;f--){g[h]===d[f]&&d.splice(f,1)}}j.selection.select(d[0])}(c,b),c.nodeChanged()},aC=function(h){var m,q,j,b,d,f=[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"Source",onpaste:function(){setTimeout(function(){ai(h,m.toJSON()).then(ah(m,h))["catch"](au(h))},1)},onchange:function(i){var c,a;ai(h,m.toJSON()).then(ah(m,h))["catch"](au(h)),c=m,a=i.meta,aM.each(a,function(n,l){c.find("#"+l).value(n)})},onbeforecall:function(a){a.meta=m.toJSON()}}],k=[];if(aV(h)&&k.push({name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"}),a4(h)&&k.push({name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"}),a0(h)){var v=at(function(a){a(m),q=m.toJSON(),m.find("#embed").value(aD(q.embed,q))});f.push(v)}b=(j=h).selection.getNode(),d=b.getAttribute("data-ephox-embed-iri"),q=d?{source1:d,"data-ephox-embed-iri":d,width:a2.getMaxWidth(b),height:a2.getMaxHeight(b)}:b.getAttribute("data-mce-object")?aY(aL(j),j.serializer.serialize(b,{selection:!0})):{};var p={id:"mcemediasource",type:"textbox",flex:1,name:"embed",value:function(c){var a=c.selection.getNode();if(a.getAttribute("data-mce-object")||a.getAttribute("data-ephox-embed-iri")){return c.selection.getContent()}}(h),multiline:!0,rows:5,label:"Source"};p[ay]=function(){q=aM.extend({},aY(aL(h),this.value())),this.parent().parent().fromJSON(q)};var g=[{title:"General",type:"form",items:f},{title:"Embed",type:"container",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,items:[{type:"label",text:"Paste your embed code below:",forId:"mcemediasource"},p]}];0<k.length&&g.push({title:"Advanced",type:"form",items:k}),m=h.windowManager.open({title:"Insert/edit media",data:q,bodyType:"tabpanel",body:g,onSubmit:function(){var a,c;aA(m),a=h,(c=m.toJSON()).embed=aD(c.embed,c),c.embed&&aE(c.source1)?ag(a,c.embed):ai(a,c).then(function(i){ag(a,i.html)})["catch"](au(a))}}),ak(m)},aw=function(a){return{showDialog:function(){aC(a)}}},aR=function(a){a.addCommand("mceMedia",function(){aC(a)})},ar=tinymce.util.Tools.resolve("tinymce.html.Node"),al=function(b,c){if(!1===aO(b)){return c}var d,f=a9();return aS({validate:!1,allow_conditional_comments:!1,special:"script,noscript",comment:function(a){f.comment(a)},cdata:function(a){f.cdata(a)},text:function(g,a){f.text(g,a)},start:function(j,g,h){if(d=!0,"script"!==j&&"noscript"!==j){for(var a=0;a<g.length;a++){if(0===g[a].name.indexOf("on")){return}"style"===g[a].name&&(g[a].value=b.dom.serializeStyle(b.dom.parseStyle(g[a].value),j))}f.start(j,g,h),d=!1}},end:function(a){d||f.end(a)}},aB({})).parse(c),f.getContent()},ac=function(d,b){var c,a=b.name;return(c=new ar("img",1)).shortEnded=!0,aa(d,b,c),c.attr({width:b.attr("width")||"300",height:b.attr("height")||("audio"===a?"30":"150"),style:b.attr("style"),src:aT.transparentSrc,"data-mce-object":a,"class":"mce-object mce-object-"+a}),c},ab=function(g,d){var f,c,b,h=d.name;return(f=new ar("span",1)).attr({contentEditable:"false",style:d.attr("style"),"data-mce-object":h,"class":"mce-preview-object mce-object-"+h}),aa(g,d,f),(c=new ar(h,1)).attr({src:d.attr("src"),allowfullscreen:d.attr("allowfullscreen"),style:d.attr("style"),"class":d.attr("class"),width:d.attr("width"),height:d.attr("height"),frameborder:"0"}),(b=new ar("span",1)).attr("class","mce-shim"),f.append(c),f.append(b),f},aa=function(h,f,g){var d,b,j,l,k;for(l=(j=f.attributes).length;l--;){d=j[l].name,b=j[l].value,"width"!==d&&"height"!==d&&"style"!==d&&("data"!==d&&"src"!==d||(b=h.convertURL(b,d)),g.attr("data-mce-p-"+d,b))}(k=f.firstChild&&f.firstChild.value)&&(g.attr("data-mce-html",escape(al(h,k))),g.firstChild=null)},a7=function(a){for(;a=a.parent;){if(a.attr("data-ephox-embed-iri")){return !0}}return !1},ad=function(b){return function(f){for(var c,d,a=f.length;a--;){(c=f[a]).parent&&(c.parent.attr("data-mce-object")||("script"!==c.name||(d=aK(aL(b),c.attr("src"))))&&(d&&(d.width&&c.attr("width",d.width.toString()),d.height&&c.attr("height",d.height.toString())),"iframe"===c.name&&aU(b)&&aT.ceFalse?a7(c)||c.replace(ab(b,c)):a7(c)||c.replace(ac(b,c))))}}},aJ=function(a){a.on("preInit",function(){var b=a.schema.getSpecialElements();aM.each("video audio iframe object".split(" "),function(d){b[d]=new RegExp("</"+d+"[^>]*>","gi")});var c=a.schema.getBoolAttrs();aM.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(d){c[d]={}}),a.parser.addNodeFilter("iframe,video,audio,object,embed,script",ad(a)),a.serializer.addAttributeFilter("data-mce-object",function(p,x){for(var d,k,v,f,g,q,y,w,j=p.length;j--;){if((d=p[j]).parent){for(y=d.attr(x),k=new ar(y,1),"audio"!==y&&"script"!==y&&((w=d.attr("class"))&&-1!==w.indexOf("mce-preview-object")?k.attr({width:d.firstChild.attr("width"),height:d.firstChild.attr("height")}):k.attr({width:d.attr("width"),height:d.attr("height")})),k.attr({style:d.attr("style")}),v=(f=d.attributes).length;v--;){var h=f[v].name;0===h.indexOf("data-mce-p-")&&k.attr(h.substr(11),f[v].value)}"script"===y&&k.attr("type","text/javascript"),(g=d.attr("data-mce-html"))&&((q=new ar("#text",3)).raw=!0,q.value=al(a,unescape(g)),k.append(q)),d.replace(k)}}})}),a.on("setContent",function(){a.$("span.mce-preview-object").each(function(d,b){var c=a.$(b);0===c.find("span.mce-shim",b).length&&c.append('<span class="mce-shim"></span>')})})},aF=function(a){a.on("ResolveName",function(c){var b;1===c.target.nodeType&&(b=c.target.getAttribute("data-mce-object"))&&(c.name=b)})},az=function(a){a.on("click keyup",function(){var b=a.selection.getNode();b&&a.dom.hasClass(b,"mce-preview-object")&&a.dom.getAttrib(b,"data-mce-selected")&&b.setAttribute("data-mce-selected","2")}),a.on("ObjectSelected",function(c){var b=c.target.getAttribute("data-mce-object");"audio"!==b&&"script"!==b||c.preventDefault()}),a.on("objectResized",function(d){var b,c=d.target;c.getAttribute("data-mce-object")&&(b=c.getAttribute("data-mce-html"))&&(b=unescape(b),c.setAttribute("data-mce-html",escape(aD(b,{width:d.width,height:d.height}))))})},aG=function(a){a.addButton("media",{tooltip:"Insert/edit media",cmd:"mceMedia",stateSelector:["img[data-mce-object]","span[data-mce-object]","div[data-ephox-embed-iri]"]}),a.addMenuItem("media",{icon:"media",text:"Media",cmd:"mceMedia",context:"insert",prependToContext:!0})};a3.add("media",function(a){return aR(a),aG(a),aF(a),aJ(a),az(a),aw(a)})}();