!function(){var F,y,p=tinymce.util.Tools.resolve("tinymce.PluginManager"),q=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),E=tinymce.util.Tools.resolve("tinymce.util.I18n"),B=tinymce.util.Tools.resolve("tinymce.util.Tools"),A=function(a){return a.getParam("toc_class","mce-toc")},z=function(a){var c=a.getParam("toc_header","h2");return/^h[1-6]$/.test(c)?c:"h2"},H=function(a){var c=parseInt(a.getParam("toc_depth","3"),10);return 1<=c&&c<=9?c:3},I=(F="mcetoc_",y=0,function(){var a=(new Date).getTime().toString(32);return F+a+(y++).toString(32)}),j=function(g){var f=A(g),a=z(g),d=function(h){var i,l=[];for(i=1;i<=h;i++){l.push("h"+i)}return l.join(",")}(H(g)),c=g.$(d);return c.length&&/^h[1-9]$/i.test(a)&&(c=c.filter(function(h,i){return !g.dom.hasClass(i.parentNode,f)})),B.map(c,function(e){return{id:e.id?e.id:I(),level:parseInt(e.nodeName.replace(/^H/i,""),10),title:g.$.text(e),element:e}})},G=function(N){var v,h,g,f,s,K,m,L="",J=j(N),M=function(a){var c,d=9;for(c=0;c<a.length;c++){if(a[c].level<d&&(d=a[c].level),1===d){return d}}return d}(J)-1;if(!J.length){return""}for(L+=(s=z(N),K=E.translate("Table of Contents"),m="</"+s+">","<"+s+' contenteditable="true">'+q.DOM.encode(K)+m),v=0;v<J.length;v++){if((g=J[v]).element.id=g.id,f=J[v+1]&&J[v+1].level,M===g.level){L+="<li>"}else{for(h=M;h<g.level;h++){L+="<ul><li>"}}if(L+='<a href="#'+g.id+'">'+g.title+"</a>",f!==g.level&&f){for(h=g.level;f<h;h--){L+="</li></ul><li>"}}else{L+="</li>",f||(L+="</ul>")}M=g.level}return L},k=function(a){var c=A(a),d=a.$("."+c);d.length&&a.undoManager.transact(function(){d.html(G(a))})},x={hasHeaders:function(a){return 0<j(a).length},insertToc:function(d){var g,m,h,f,a=A(d),l=d.$("."+a);h=d,!(f=l).length||0<h.dom.getParents(f[0],".mce-offscreen-selection").length?d.insertContent((m=G(g=d),'<div class="'+g.dom.encode(A(g))+'" contenteditable="false">'+m+"</div>")):k(d)},updateToc:k},w=function(a){a.addCommand("mceInsertToc",function(){x.insertToc(a)}),a.addCommand("mceUpdateToc",function(){x.updateToc(a)})},C=function(a){var d=a.$,c=A(a);a.on("PreProcess",function(f){var g=d("."+c,f.node);g.length&&(g.removeAttr("contentEditable"),g.find("[contenteditable]").removeAttr("contentEditable"))}),a.on("SetContent",function(){var e=d("."+c);e.length&&(e.attr("contentEditable",!1),e.children(":first-child").attr("contentEditable",!0))})},D=function(a){return function(c){var d=c.control;a.on("LoadContent SetContent change",function(){d.disabled(a.readonly||!x.hasHeaders(a))})}},b=function(a){var c;a.addButton("toc",{tooltip:"Table of Contents",cmd:"mceInsertToc",icon:"toc",onPostRender:D(a)}),a.addButton("tocupdate",{tooltip:"Update",cmd:"mceUpdateToc",icon:"reload"}),a.addMenuItem("toc",{text:"Table of Contents",context:"insert",cmd:"mceInsertToc",onPostRender:D(a)}),a.addContextToolbar((c=a,function(d){return d&&c.dom.is(d,"."+A(c))&&c.getBody().contains(d)}),"tocupdate")};p.add("toc",function(a){w(a),b(a),C(a)})}();